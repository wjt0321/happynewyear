# 实施计划：微信小程序新年抽签应用

## 概述

本实施计划将微信小程序新年抽签应用的开发分解为离散的编程步骤，采用增量开发方式，确保每个任务都能独立执行并构建在前一个任务的基础上。项目使用uni-app + Vue3 + TypeScript开发前端，Node.js + Express + TypeScript开发后端，通过Docker容器化部署。

## 任务

- [x] 1. 搭建后端项目基础架构
  - ✅ 创建Node.js + Express + TypeScript项目结构
  - ✅ 配置开发环境和构建工具
  - ✅ 设置better-sqlite3数据库连接
  - ✅ 实现基础中间件（CORS、JSON解析、错误处理、安全头）
  - ✅ 配置环境变量管理（dotenv）
  - ✅ 设置完整的npm脚本和构建流程
  - _需求：需求 5, 6, 8_

- [x] 1.1 编写后端项目基础测试
  - 配置Jest测试框架
  - 编写数据库连接测试
  - 编写基础中间件测试
  - _需求：需求 5, 6_

- [x] 2. 实现数据库模型和初始化
  - [x] 2.1 创建SQLite数据库表结构
    - 实现fortunes表和user_draws表的创建脚本
    - 添加必要的索引和外键约束
    - _需求：需求 6.1, 6.3_

  - [x] 2.2 实现数据库初始化脚本
    - 创建50条新年运势数据
    - 实现数据库自动初始化逻辑
    - _需求：需求 2.2_

  - [x] 2.3 编写数据库模型属性测试
    - **属性 3: 运势ID唯一性**
    - **验证需求：需求 2.3**

  - [x] 2.4 编写数据库初始化单元测试
    - 测试表结构创建
    - 测试运势数据插入
    - _需求：需求 6.1, 2.2_

- [x] 3. 实现抽签核心业务逻辑
  - [x] 3.1 实现用户抽签历史查询功能
    - 编写按openid查询用户抽签记录的函数
    - 实现获取用户可用运势列表的逻辑
    - _需求：需求 6.5, 2.4_

  - [x] 3.2 实现抽签冷却机制
    - 编写时间间隔检查逻辑
    - 实现10秒冷却期控制
    - _需求：需求 4.1, 4.2, 4.3, 4.4_

  - [x] 3.3 实现随机抽签算法
    - 编写从可用运势中随机选择的函数
    - 实现抽签记录保存逻辑
    - _需求：需求 2.1, 6.2_

  - [x] 3.4 编写抽签业务逻辑属性测试
    - **属性 2: 运势随机选择正确性**
    - **属性 7: 抽签冷却机制**
    - **属性 8: 抽签记录完整性**
    - **属性 9: 用户历史查询准确性**
    - **验证需求：需求 2.1, 2.4, 4.1-4.4, 6.2, 6.3, 6.5**

  - [x] 3.5 编写业务逻辑单元测试
    - 测试冷却期边界情况
    - 测试运势池耗尽情况
    - 测试数据库错误处理
    - _需求：需求 2.1, 4.1-4.4, 6.2_

- [x] 4. 实现抽签API接口
  - [x] 4.1 创建抽签API端点
    - 实现POST /api/fortune接口
    - 添加请求参数验证中间件
    - 实现响应格式标准化
    - _需求：需求 5.1, 5.2, 5.3_

  - [x] 4.2 实现健康检查接口
    - 创建GET /api/health端点
    - 添加数据库连接状态检查
    - _需求：需求 5_

  - [x] 4.3 编写API接口属性测试
    - **属性 4: 用户身份识别一致性**
    - **属性 5: API请求格式验证**
    - **属性 6: API响应格式一致性**
    - **验证需求：需求 2.5, 5.2, 5.3, 8.3**

  - [x] 4.4 编写API接口单元测试
    - 测试有效请求处理
    - 测试无效openid处理
    - 测试服务器错误处理
    - _需求：需求 5.1, 5.2, 5.3_

- [x] 5. 检查点 - 后端服务完整性验证
  - 确保所有测试通过，询问用户是否有问题

- [x] 6. 搭建前端项目基础架构
  - 创建uni-app + Vue3 + TypeScript项目
  - 配置开发环境和构建工具
  - 设置项目目录结构和路由
  - 配置Pinia状态管理
  - _需求：需求 8.1, 8.4_

- [x] 6.1 配置前端测试环境
  - 设置Jest + Vue Test Utils测试框架
  - 配置TypeScript测试支持
  - _需求：需求 8.1_

- [x] 7. 实现新年主题样式系统
  - [x] 7.1 创建新年主题色彩和字体配置
    - 实现theme.scss主题样式文件
    - 定义中国红、金黄色等新年色彩变量
    - 配置楷体等装饰性字体
    - _需求：需求 1.1, 1.2_

  - [x] 7.2 实现响应式设计适配
    - 创建responsive.scss响应式样式
    - 适配iPhone和安卓主流机型
    - 实现安全区域适配
    - _需求：需求 1.4_

  - [x] 7.3 编写响应式设计属性测试
    - **属性 1: 响应式布局适配**
    - **验证需求：需求 1.4**

- [x] 8. 实现动画背景组件
  - [x] 8.1 创建AnimatedBackground组件
    - 实现飘雪动画效果
    - 实现烟花爆炸动画
    - 添加浮动装饰元素（灯笼、金币、龙等）
    - _需求：需求 1.1, 1.2_

  - [x] 8.2 编写动画组件单元测试
    - 测试动画元素渲染
    - 测试动画效果触发
    - _需求：需求 1.2_

- [ ] 9. 实现抽签按钮组件
  - [x] 9.1 创建FortuneButton组件
    - 实现圆形金色按钮设计
    - 添加旋转装饰环和闪烁星星动画
    - 实现按钮状态管理（正常、抽签中、冷却中）
    - _需求：需求 1.3, 4.2_

  - [x] 9.2 实现冷却倒计时显示
    - 添加CountdownTimer组件
    - 实现倒计时数字显示和动画
    - _需求：需求 4.2_

  - [x] 9.3 编写抽签按钮组件单元测试
    - 测试按钮渲染和状态切换
    - 测试冷却期间按钮禁用
    - 测试点击事件处理
    - _需求：需求 1.3, 4.2_

- [x] 10. 实现用户状态管理
  - [x] 10.1 创建用户状态Store
    - 实现用户openid存储和管理
    - 添加登录状态跟踪
    - 实现抽签冷却状态管理
    - _需求：需求 2.5, 4.4, 8.3_

  - [x] 10.2 实现微信登录功能
    - 集成微信小程序登录API
    - 实现openid获取和存储
    - 添加登录错误处理
    - _需求：需求 8.3_

  - [x] 10.3 编写用户状态管理单元测试
    - 测试状态更新和持久化
    - 测试登录流程
    - _需求：需求 2.5, 8.3_

- [x] 11. 实现API调用服务
  - [x] 11.1 创建API调用封装
    - 实现统一的HTTP请求封装
    - 添加请求拦截器和错误处理
    - 实现抽签API调用函数
    - _需求：需求 5.1, 5.2, 5.3_

  - [x] 11.2 实现网络错误处理
    - 添加网络超时处理
    - 实现重试机制
    - 添加用户友好的错误提示
    - _需求：需求 5_

  - [x] 11.3 编写API调用服务单元测试
    - 测试成功请求处理
    - 测试网络错误处理
    - 测试重试机制
    - _需求：需求 5.1, 5.2, 5.3_

- [x] 12. 实现首页界面
  - [x] 12.1 创建首页组件
    - 实现首页布局和样式
    - 集成动画背景组件
    - 添加新年装饰元素
    - _需求：需求 1.1, 1.2, 1.3_

  - [x] 12.2 实现抽签交互逻辑
    - 连接抽签按钮和API调用
    - 实现抽签状态管理
    - 添加抽签结果页面跳转
    - _需求：需求 2.1, 2.5_

  - [x] 12.3 编写首页组件单元测试
    - 测试页面渲染和布局
    - 测试抽签交互流程
    - _需求：需求 1.1, 1.2, 1.3, 2.1_

- [x] 13. 实现结果页界面
  - [x] 13.1 创建结果页组件
    - 实现运势卡片设计
    - 添加金光闪烁动画效果
    - 实现庆祝粒子动画
    - _需求：需求 3.1, 3.2_

  - [x] 13.2 实现分享功能
    - 集成微信分享API
    - 实现分享内容定制
    - 添加分享按钮交互
    - _需求：需求 3.3, 3.4_

  - [x] 13.3 实现再次抽签功能
    - 添加"再抽一次"按钮
    - 实现冷却期状态显示
    - 连接返回首页逻辑
    - _需求：需求 3.5, 4.1, 4.2, 4.3_

  - [x] 13.4 编写结果页组件单元测试
    - 测试运势显示和动画
    - 测试分享功能调用
    - 测试再次抽签逻辑
    - _需求：需求 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 14. 检查点 - 前端功能完整性验证
  - 确保所有测试通过，询问用户是否有问题

- [x] 15. 实现Docker容器化部署
  - [x] 15.1 创建后端Dockerfile
    - 实现多阶段构建配置
    - 添加健康检查和安全配置
    - 配置数据目录挂载
    - _需求：需求 7.1, 7.2_

  - [x] 15.2 创建Docker Compose配置
    - 配置服务编排和网络
    - 实现数据持久化挂载
    - 添加环境变量配置
    - _需求：需求 7.4, 7.5_

  - [x] 15.3 创建部署脚本
    - 实现自动化部署脚本
    - 添加健康检查和回滚机制
    - 配置Cloudflare Tunnel集成说明
    - _需求：需求 7.3, 7.5_

  - [x] 15.4 编写容器化部署测试
    - 测试Docker镜像构建
    - 测试容器启动和健康检查
    - _需求：需求 7.1, 7.2_

- [x] 16. 系统集成和端到端测试
  - [x] 16.1 实现前后端集成
    - 连接前端和后端服务
    - 配置开发环境代理
    - 验证完整用户流程
    - _需求：需求 1-8_

  - [x] 16.2 编写端到端集成测试
    - 测试完整抽签流程
    - 测试错误处理场景
    - 测试并发用户场景
    - _需求：需求 1-8_

- [x] 17. 最终检查点 - 系统完整性验证
  - 确保所有测试通过，询问用户是否有问题

## 注意事项

- 每个任务都引用了具体的需求条目以确保可追溯性
- 检查点任务确保增量验证和用户反馈
- 属性测试验证通用正确性属性
- 单元测试验证具体示例和边界情况
- 集成测试验证组件间交互和端到端流程
- 所有测试任务都是必需的，确保从一开始就有全面的测试覆盖