# ğŸš€ å¾®ä¿¡å°ç¨‹åºæ–°å¹´æŠ½ç­¾åº”ç”¨ - éƒ¨ç½²æŒ‡å—

## ğŸ“‹ éƒ¨ç½²æ¦‚è§ˆ

æœ¬æŒ‡å—å°†å¸®åŠ©æ‚¨å°†å¾®ä¿¡å°ç¨‹åºæ–°å¹´æŠ½ç­¾åº”ç”¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒã€‚æˆ‘ä»¬æä¾›å¤šç§éƒ¨ç½²æ–¹æ¡ˆï¼ŒåŒ…æ‹¬äº‘æœåŠ¡å™¨éƒ¨ç½²ã€NASç¯å¢ƒéƒ¨ç½²å’Œæœ¬åœ°å¼€å‘éƒ¨ç½²ã€‚

## ğŸ¯ éƒ¨ç½²æ¶æ„å¯¹æ¯”

### éƒ¨ç½²æ–¹å¼é€‰æ‹©

| éƒ¨ç½²æ–¹å¼ | é€‚ç”¨åœºæ™¯ | ç«¯å£é…ç½® | é…ç½®æ–‡ä»¶ | ä¸»è¦ç‰¹ç‚¹ |
|---------|---------|---------|----------|----------|
| **å¼€å‘ç¯å¢ƒ** | æœ¬åœ°å¼€å‘è°ƒè¯• | 3000 | `docker-compose.dev.yml` | çƒ­é‡è½½ã€è°ƒè¯•æ¨¡å¼ã€å¼€å‘å·¥å…· |
| **ç”Ÿäº§ç¯å¢ƒ** | äº‘æœåŠ¡å™¨éƒ¨ç½² | 3000 | `docker-compose.prod.yml` | Cloudflareéš§é“ã€æ€§èƒ½ä¼˜åŒ– |
| **ğŸ†• NASç¯å¢ƒ** | **NASç³»ç»Ÿéƒ¨ç½²** | **18080** | **`docker-compose.nas.yml`** | **é«˜ç«¯å£ã€èµ„æºä¼˜åŒ–ã€NASé€‚é…** |

### æ¨èæ¶æ„
```
# äº‘æœåŠ¡å™¨éƒ¨ç½²æ¶æ„
ç”¨æˆ· â†’ å¾®ä¿¡å°ç¨‹åº â†’ Cloudflare â†’ äº‘æœåŠ¡å™¨ â†’ Dockerå®¹å™¨ â†’ SQLiteæ•°æ®åº“

# NASç¯å¢ƒéƒ¨ç½²æ¶æ„ï¼ˆæ–°å¢ï¼‰
ç”¨æˆ· â†’ å¾®ä¿¡å°ç¨‹åº â†’ NASç½‘ç»œ â†’ Dockerå®¹å™¨ â†’ SQLiteæ•°æ®åº“
```

### ç»„ä»¶è¯´æ˜
- **å¾®ä¿¡å°ç¨‹åº**: å‰ç«¯ç”¨æˆ·ç•Œé¢
- **Cloudflare**: CDNåŠ é€Ÿå’Œå®‰å…¨é˜²æŠ¤ï¼ˆäº‘æœåŠ¡å™¨éƒ¨ç½²ï¼‰
- **äº‘æœåŠ¡å™¨/NAS**: è¿è¡Œåç«¯æœåŠ¡çš„ç¡¬ä»¶å¹³å°
- **Dockerå®¹å™¨**: åº”ç”¨å®¹å™¨åŒ–è¿è¡Œ
- **SQLiteæ•°æ®åº“**: æ•°æ®æŒä¹…åŒ–å­˜å‚¨

## ğŸ› ï¸ ç¯å¢ƒå‡†å¤‡

### æœåŠ¡å™¨è¦æ±‚
- **CPU**: 2æ ¸å¿ƒä»¥ä¸Š
- **å†…å­˜**: 4GBä»¥ä¸Š
- **å­˜å‚¨**: 40GBä»¥ä¸ŠSSD
- **ç½‘ç»œ**: 5Mbpsä»¥ä¸Šå¸¦å®½
- **ç³»ç»Ÿ**: Ubuntu 20.04 LTSï¼ˆæ¨èï¼‰

### è½¯ä»¶ä¾èµ–
- Docker 20.10+
- Docker Compose 2.0+
- Git 2.25+
- Nginx 1.18+ï¼ˆå¯é€‰ï¼‰

## ğŸ”§ å¿«é€Ÿéƒ¨ç½²

### ğŸ†• NASç¯å¢ƒéƒ¨ç½²ï¼ˆæ¨èæ–°ç”¨æˆ·ï¼‰

#### æ–°å¢NASä¸“ç”¨é…ç½®

é¡¹ç›®ç°åœ¨æä¾›äº†ä¸“é—¨ä¸ºNASç¯å¢ƒä¼˜åŒ–çš„éƒ¨ç½²é…ç½®ï¼š

**é…ç½®æ–‡ä»¶ï¼š**
- **`docker-compose.nas.yml`** - NASä¸“ç”¨Docker Composeé…ç½®
- **`.env.nas.example`** - NASç¯å¢ƒå˜é‡æ¨¡æ¿

**NASé…ç½®ä¼˜åŒ–ç‰¹æ€§ï¼š**
1. **ç«¯å£ä¼˜åŒ–**ï¼šä½¿ç”¨18080/18082é«˜ç«¯å£é¿å…ä¸NASç°æœ‰æœåŠ¡å†²çª
2. **èµ„æºç®¡ç†**ï¼šé’ˆå¯¹NASç¡¬ä»¶ç‰¹ç‚¹çš„CPUå’Œå†…å­˜é™åˆ¶é…ç½®
3. **å®‰å…¨å¢å¼º**ï¼šåªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿã€å®‰å…¨é€‰é¡¹é…ç½®
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šSQLite WALæ¨¡å¼ã€æ•°æ®åº“ç¼“å­˜ä¼˜åŒ–
5. **ç›‘æ§å®Œå–„**ï¼šç‹¬ç«‹å¥åº·æ£€æŸ¥è„šæœ¬å’Œæ—¥å¿—ç®¡ç†
6. **æ•°æ®æŒä¹…åŒ–**ï¼šä¼˜åŒ–çš„æ•°æ®å·æŒ‚è½½ç­–ç•¥
7. **ç¯å¢ƒé€‚é…**ï¼šæ”¯æŒç¾¤æ™–ã€å¨è”é€šç­‰ä¸»æµNASç³»ç»Ÿ

#### NASå¿«é€Ÿéƒ¨ç½²æ­¥éª¤

```bash
# 1. å‡†å¤‡ç¯å¢ƒé…ç½®
cp .env.nas.example .env.nas
# ç¼–è¾‘ .env.nas æ–‡ä»¶ï¼Œè®¾ç½®æ­£ç¡®çš„NASè·¯å¾„å’Œç«¯å£

# 2. åˆ›å»ºNASæ•°æ®ç›®å½•
mkdir -p /volume1/docker/wechat-fortune-draw/{data,logs}
chmod 755 /volume1/docker/wechat-fortune-draw

# 3. å¯åŠ¨NASæœåŠ¡
docker-compose -f docker-compose.nas.yml --env-file .env.nas up -d

# 4. éªŒè¯NASæœåŠ¡
curl http://localhost:18080/api/health
```

#### NASè®¿é—®åœ°å€
- **åç«¯API**: `http://NAS_IP:18080`
- **æ•°æ®åº“ç®¡ç†**: `http://NAS_IP:18082`ï¼ˆå¯é€‰çš„Adminerå·¥å…·ï¼‰
- **å¥åº·æ£€æŸ¥**: `http://NAS_IP:18080/api/health`

### äº‘æœåŠ¡å™¨éƒ¨ç½²ï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰

### 1. æœåŠ¡å™¨åˆå§‹åŒ–
```bash
# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# å®‰è£…åŸºç¡€å·¥å…·
sudo apt install -y curl wget git vim htop

# å®‰è£…Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# å®‰è£…Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# é‡æ–°ç™»å½•ä»¥åº”ç”¨Dockerç»„æƒé™
exit
```

### 2. éƒ¨ç½²åº”ç”¨
```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/your-username/wechat-fortune-draw.git
cd wechat-fortune-draw

# é…ç½®ç¯å¢ƒå˜é‡
cp .env.docker .env
vim .env  # ç¼–è¾‘é…ç½®æ–‡ä»¶

# è®¾ç½®æ•°æ®ç›®å½•æƒé™
mkdir -p data logs
sudo chown -R 1001:1001 data logs

# å¯åŠ¨æœåŠ¡ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
docker-compose -f docker-compose.dev.yml up -d

# æˆ–å¯åŠ¨ç”Ÿäº§ç¯å¢ƒï¼ˆéœ€è¦é…ç½®TUNNEL_TOKENï¼‰
docker-compose -f docker-compose.prod.yml up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps
```

### 3. éªŒè¯éƒ¨ç½²
```bash
# æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
curl http://localhost:3000/api/health

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f
```

## ğŸ“ é…ç½®è¯¦è§£

### ç¯å¢ƒå˜é‡é…ç½®
```env
# .env - ä¸»é…ç½®æ–‡ä»¶
# åç«¯æœåŠ¡ç«¯å£
BACKEND_PORT=3000

# æ•°æ®æŒä¹…åŒ–ç›®å½•
DATA_PATH=./data

# è¿è¡Œç¯å¢ƒ
NODE_ENV=production

# Cloudflare Tunnel Tokenï¼ˆç”Ÿäº§ç¯å¢ƒå¿…éœ€ï¼‰
TUNNEL_TOKEN=your_tunnel_token_here

# å…è®¸çš„è·¨åŸŸæ¥æº
CORS_ORIGINS=https://servicewechat.com,https://your-domain.com

# å¾®ä¿¡å°ç¨‹åºé…ç½®ï¼ˆå¯é€‰ï¼‰
WECHAT_APP_ID=your_wechat_app_id
WECHAT_APP_SECRET=your_wechat_app_secret

# å®‰å…¨é…ç½®
JWT_SECRET=your_super_secret_jwt_key_here

# æ—¥å¿—é…ç½®
LOG_LEVEL=info
```
### Docker Composeé…ç½®

#### ä¸»é…ç½®æ–‡ä»¶ (docker-compose.yml)
```yaml
# docker-compose.yml - åŸºç¡€é…ç½®
version: '3.8'

services:
  fortune-backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: runtime
    image: wechat-fortune-draw:latest
    container_name: fortune-backend
    restart: unless-stopped
    
    ports:
      - "${BACKEND_PORT:-3000}:3000"
    
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DB_PATH=/app/data/fortune.db
    
    volumes:
      - fortune_data:/app/data
      - ./backend/logs:/app/logs:rw
    
    healthcheck:
      test: ["CMD", "node", "-e", "const http = require('http'); const options = { host: 'localhost', port: 3000, path: '/api/health', timeout: 2000 }; const req = http.request(options, (res) => { if (res.statusCode === 200) { process.exit(0); } else { process.exit(1); } }); req.on('error', () => process.exit(1)); req.on('timeout', () => process.exit(1)); req.end();"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    
    networks:
      - fortune-network
    
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m

volumes:
  fortune_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}

networks:
  fortune-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
```

#### ç”Ÿäº§ç¯å¢ƒé…ç½® (docker-compose.prod.yml)
```yaml
# docker-compose.prod.yml - ç”Ÿäº§ç¯å¢ƒé…ç½®
version: '3.8'

services:
  fortune-backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: runtime
    image: wechat-fortune-draw:latest
    container_name: fortune-backend-prod
    restart: unless-stopped
    
    # ä»…å†…éƒ¨ç½‘ç»œè®¿é—®ï¼Œé€šè¿‡Cloudflare Tunnelå¯¹å¤–æä¾›æœåŠ¡
    expose:
      - "3000"
    
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DB_PATH=/app/data/fortune.db
      - CORS_ORIGINS=${CORS_ORIGINS:-https://servicewechat.com}
    
    volumes:
      - fortune_data:/app/data
      - ./logs:/app/logs:rw
    
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.2'
          memory: 256M
    
    networks:
      - fortune-internal
    
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m

  # Cloudflare Tunnel æœåŠ¡
  cloudflare-tunnel:
    image: cloudflare/cloudflared:latest
    container_name: fortune-cloudflare-tunnel
    restart: unless-stopped
    command: tunnel --no-autoupdate run --token ${TUNNEL_TOKEN}
    environment:
      - TUNNEL_TOKEN=${TUNNEL_TOKEN}
    depends_on:
      fortune-backend:
        condition: service_healthy
    networks:
      - fortune-internal
    security_opt:
      - no-new-privileges:true
    read_only: true

volumes:
  fortune_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}

networks:
  fortune-internal:
    driver: bridge
    internal: false
    ipam:
      config:
        - subnet: 172.21.0.0/16
```

#### å¼€å‘ç¯å¢ƒé…ç½® (docker-compose.dev.yml)
```yaml
# docker-compose.dev.yml - å¼€å‘ç¯å¢ƒé…ç½®
version: '3.8'

services:
  fortune-backend-dev:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: builder  # ä½¿ç”¨æ„å»ºé˜¶æ®µï¼ŒåŒ…å«å¼€å‘å·¥å…·
    image: wechat-fortune-draw:dev
    container_name: fortune-backend-dev
    restart: unless-stopped
    
    ports:
      - "3000:3000"
    
    environment:
      - NODE_ENV=development
      - PORT=3000
      - DB_PATH=/app/data/fortune.db
    
    volumes:
      - ./backend:/app:rw
      - /app/node_modules  # åŒ¿åå·ï¼Œé¿å…è¦†ç›–å®¹å™¨å†…çš„node_modules
      - ./data:/app/data:rw
      - ./backend/logs:/app/logs:rw
    
    command: ["npm", "run", "dev"]
    
    networks:
      - fortune-dev-network

networks:
  fortune-dev-network:
    driver: bridge
```

## ğŸŒ åŸŸåå’ŒHTTPSé…ç½®

### 1. åŸŸåè§£æ
åœ¨æ‚¨çš„åŸŸåæœåŠ¡å•†å¤„æ·»åŠ Aè®°å½•ï¼š
```
ç±»å‹: A
ä¸»æœºè®°å½•: api (æˆ– @)
è®°å½•å€¼: æ‚¨çš„æœåŠ¡å™¨IPåœ°å€
TTL: 600
```

### 2. Nginxåå‘ä»£ç†
```nginx
# /etc/nginx/sites-available/fortune-app
server {
    listen 80;
    server_name your-domain.com;
    
    # é‡å®šå‘åˆ°HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    # SSLè¯ä¹¦é…ç½®
    ssl_certificate /path/to/your/certificate.crt;
    ssl_certificate_key /path/to/your/private.key;
    
    # SSLå®‰å…¨é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
    ssl_prefer_server_ciphers off;
    
    # åå‘ä»£ç†é…ç½®
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # è¶…æ—¶é…ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # é™æ€æ–‡ä»¶ç¼“å­˜
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

### 3. å¯ç”¨Nginxé…ç½®
```bash
# åˆ›å»ºè½¯é“¾æ¥
sudo ln -s /etc/nginx/sites-available/fortune-app /etc/nginx/sites-enabled/

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡å¯Nginx
sudo systemctl restart nginx
```

### 4. SSLè¯ä¹¦ç”³è¯·ï¼ˆLet's Encryptï¼‰
```bash
# å®‰è£…Certbot
sudo apt install certbot python3-certbot-nginx

# ç”³è¯·è¯ä¹¦
sudo certbot --nginx -d your-domain.com

# è®¾ç½®è‡ªåŠ¨ç»­æœŸ
sudo crontab -e
# æ·»åŠ ä»¥ä¸‹è¡Œï¼š
# 0 12 * * * /usr/bin/certbot renew --quiet
```

## ğŸ” å®‰å…¨é…ç½®

### 1. é˜²ç«å¢™è®¾ç½®
```bash
# å¯ç”¨UFWé˜²ç«å¢™
sudo ufw enable

# å…è®¸SSH
sudo ufw allow ssh

# å…è®¸HTTPå’ŒHTTPS
sudo ufw allow 80
sudo ufw allow 443

# æŸ¥çœ‹çŠ¶æ€
sudo ufw status
```

### 2. ç³»ç»Ÿå®‰å…¨åŠ å›º
```bash
# ç¦ç”¨rootç™»å½•
sudo vim /etc/ssh/sshd_config
# è®¾ç½®: PermitRootLogin no

# åˆ›å»ºæ™®é€šç”¨æˆ·
sudo adduser deploy
sudo usermod -aG sudo deploy
sudo usermod -aG docker deploy

# é‡å¯SSHæœåŠ¡
sudo systemctl restart ssh
```

### 3. åº”ç”¨å®‰å…¨é…ç½®
```bash
# è®¾ç½®æ–‡ä»¶æƒé™
chmod 600 backend/.env
chmod 755 data/
chmod 644 data/fortune.db

# åˆ›å»ºä¸“ç”¨ç”¨æˆ·è¿è¡Œåº”ç”¨
sudo useradd -r -s /bin/false fortune-app
sudo chown -R fortune-app:fortune-app data/ logs/
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### 1. ç³»ç»Ÿç›‘æ§
```bash
# å®‰è£…ç›‘æ§å·¥å…·
sudo apt install htop iotop nethogs

# æŸ¥çœ‹ç³»ç»Ÿèµ„æº
htop
df -h
free -h
```

### 2. åº”ç”¨ç›‘æ§
```bash
# æŸ¥çœ‹Dockerå®¹å™¨çŠ¶æ€
docker stats

# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
docker-compose logs -f --tail=100

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
docker-compose logs -f app
```

### 3. æ—¥å¿—ç®¡ç†
```bash
# é…ç½®æ—¥å¿—è½®è½¬
sudo vim /etc/logrotate.d/fortune-app

# å†…å®¹ï¼š
/path/to/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 fortune-app fortune-app
    postrotate
        docker-compose restart app
    endscript
}
```

## ğŸ’¾ æ•°æ®å¤‡ä»½

### 1. è‡ªåŠ¨å¤‡ä»½è„šæœ¬
```bash
#!/bin/bash
# backup.sh

# é…ç½®
BACKUP_DIR="/home/deploy/backups"
DB_PATH="/home/deploy/wechat-fortune-draw/data/fortune.db"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="fortune_backup_$DATE.db"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤‡ä»½æ•°æ®åº“
cp $DB_PATH $BACKUP_DIR/$BACKUP_FILE

# å‹ç¼©å¤‡ä»½
gzip $BACKUP_DIR/$BACKUP_FILE

# åˆ é™¤30å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "fortune_backup_*.db.gz" -mtime +30 -delete

# ä¸Šä¼ åˆ°äº‘å­˜å‚¨ï¼ˆå¯é€‰ï¼‰
# aws s3 cp $BACKUP_DIR/$BACKUP_FILE.gz s3://your-bucket/backups/

echo "å¤‡ä»½å®Œæˆ: $BACKUP_FILE.gz"
```

### 2. è®¾ç½®å®šæ—¶å¤‡ä»½
```bash
# æ·»åŠ æ‰§è¡Œæƒé™
chmod +x backup.sh

# è®¾ç½®å®šæ—¶ä»»åŠ¡
crontab -e

# æ·»åŠ ä»¥ä¸‹è¡Œï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½ï¼‰
0 2 * * * /home/deploy/backup.sh >> /home/deploy/backup.log 2>&1
```

### 3. æ•°æ®æ¢å¤
```bash
# åœæ­¢åº”ç”¨
docker-compose down

# æ¢å¤æ•°æ®åº“
gunzip -c /path/to/backup/fortune_backup_20260106_020000.db.gz > data/fortune.db

# é‡å¯åº”ç”¨
docker-compose up -d
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“ä¼˜åŒ–
```sql
-- æ•°æ®åº“ç»´æŠ¤è„šæœ¬
-- optimize_db.sql

-- é‡å»ºç´¢å¼•
REINDEX;

-- æ¸…ç†æ•°æ®åº“
VACUUM;

-- åˆ†ææŸ¥è¯¢è®¡åˆ’
ANALYZE;
```

### 2. åº”ç”¨æ€§èƒ½è°ƒä¼˜
```bash
# è°ƒæ•´Dockerå®¹å™¨èµ„æºé™åˆ¶
# docker-compose.prod.yml
services:
  app:
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
```

### 3. ç¼“å­˜é…ç½®
```nginx
# Nginxç¼“å­˜é…ç½®
location /api/ {
    # APIæ¥å£ä¸ç¼“å­˜
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    proxy_pass http://localhost:3000;
}

location /static/ {
    # é™æ€èµ„æºé•¿æœŸç¼“å­˜
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

## ğŸ”„ æ›´æ–°éƒ¨ç½²

### 1. æ»šåŠ¨æ›´æ–°
```bash
#!/bin/bash
# update.sh

echo "å¼€å§‹æ›´æ–°éƒ¨ç½²..."

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# å¤‡ä»½å½“å‰æ•°æ®
./backup.sh

# æ„å»ºæ–°é•œåƒ
docker-compose -f docker-compose.prod.yml build

# é‡å¯æœåŠ¡
docker-compose -f docker-compose.prod.yml up -d

# ç­‰å¾…æœåŠ¡å¯åŠ¨
sleep 30

# å¥åº·æ£€æŸ¥
if curl -f http://localhost:3000/api/health; then
    echo "âœ… æ›´æ–°æˆåŠŸ"
else
    echo "âŒ æ›´æ–°å¤±è´¥ï¼Œå¼€å§‹å›æ»š"
    # è¿™é‡Œå¯ä»¥æ·»åŠ å›æ»šé€»è¾‘
fi
```

### 2. è“ç»¿éƒ¨ç½²
```bash
# è“ç»¿éƒ¨ç½²è„šæœ¬
# blue-green-deploy.sh

# å½“å‰è¿è¡Œçš„æ˜¯è“è‰²ç¯å¢ƒï¼Œéƒ¨ç½²åˆ°ç»¿è‰²ç¯å¢ƒ
docker-compose -f docker-compose.green.yml up -d

# ç­‰å¾…ç»¿è‰²ç¯å¢ƒå¯åŠ¨
sleep 30

# å¥åº·æ£€æŸ¥
if curl -f http://localhost:3001/api/health; then
    # åˆ‡æ¢Nginxé…ç½®åˆ°ç»¿è‰²ç¯å¢ƒ
    sudo cp nginx.green.conf /etc/nginx/sites-available/fortune-app
    sudo nginx -s reload
    
    # åœæ­¢è“è‰²ç¯å¢ƒ
    docker-compose -f docker-compose.blue.yml down
    
    echo "âœ… è“ç»¿éƒ¨ç½²æˆåŠŸ"
else
    echo "âŒ ç»¿è‰²ç¯å¢ƒå¯åŠ¨å¤±è´¥"
    docker-compose -f docker-compose.green.yml down
fi
```

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. å®¹å™¨å¯åŠ¨å¤±è´¥
```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
docker-compose logs app

# æ£€æŸ¥é…ç½®æ–‡ä»¶
docker-compose config

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep :3000
```

#### 2. æ•°æ®åº“è¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶æƒé™
ls -la data/fortune.db

# æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶å®Œæ•´æ€§
sqlite3 data/fortune.db "PRAGMA integrity_check;"

# é‡æ–°åˆå§‹åŒ–æ•°æ®åº“
rm data/fortune.db
docker-compose restart app
```

#### 3. å†…å­˜ä¸è¶³
```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h
docker stats

# æ·»åŠ äº¤æ¢ç©ºé—´
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# æ°¸ä¹…å¯ç”¨äº¤æ¢ç©ºé—´
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```

#### 4. ç£ç›˜ç©ºé—´ä¸è¶³
```bash
# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
df -h

# æ¸…ç†Dockeré•œåƒ
docker system prune -a

# æ¸…ç†æ—¥å¿—æ–‡ä»¶
sudo journalctl --vacuum-time=7d
```

## ğŸ“ˆ æ‰©å®¹æ–¹æ¡ˆ

### 1. å‚ç›´æ‰©å®¹
```bash
# å‡çº§æœåŠ¡å™¨é…ç½®
# å¢åŠ CPUå’Œå†…å­˜èµ„æº

# è°ƒæ•´Dockerèµ„æºé™åˆ¶
# ä¿®æ”¹docker-compose.prod.ymlä¸­çš„èµ„æºé…ç½®
```

### 2. æ°´å¹³æ‰©å®¹
```yaml
# docker-compose.scale.yml
version: '3.8'

services:
  app:
    build: ./backend
    deploy:
      replicas: 3
    ports:
      - "3000-3002:3000"
    
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - app
```

### 3. è´Ÿè½½å‡è¡¡é…ç½®
```nginx
# nginx.conf
upstream fortune_backend {
    server localhost:3000;
    server localhost:3001;
    server localhost:3002;
}

server {
    listen 80;
    
    location / {
        proxy_pass http://fortune_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

## ğŸ“‹ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰æ£€æŸ¥
- [ ] æœåŠ¡å™¨èµ„æºå……è¶³
- [ ] åŸŸåè§£ææ­£ç¡®
- [ ] SSLè¯ä¹¦æœ‰æ•ˆ
- [ ] ç¯å¢ƒå˜é‡é…ç½®å®Œæ•´
- [ ] æ•°æ®åº“å¤‡ä»½å®Œæˆ

### éƒ¨ç½²åéªŒè¯
- [ ] æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡
- [ ] APIæ¥å£å“åº”æ­£å¸¸
- [ ] æ•°æ®åº“è¿æ¥æ­£å¸¸
- [ ] æ—¥å¿—è®°å½•æ­£å¸¸
- [ ] ç›‘æ§å‘Šè­¦é…ç½®

### å®‰å…¨æ£€æŸ¥
- [ ] é˜²ç«å¢™è§„åˆ™æ­£ç¡®
- [ ] SSLé…ç½®å®‰å…¨
- [ ] æ–‡ä»¶æƒé™åˆç†
- [ ] æ•æ„Ÿä¿¡æ¯ä¿æŠ¤
- [ ] è®¿é—®æ—¥å¿—è®°å½•

---

**ğŸŠ æ­å–œï¼æ‚¨å·²æˆåŠŸéƒ¨ç½²å¾®ä¿¡å°ç¨‹åºæ–°å¹´æŠ½ç­¾åº”ç”¨ï¼ğŸŠ**

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒæ•…éšœæ’é™¤ç« èŠ‚æˆ–è”ç³»æŠ€æœ¯æ”¯æŒã€‚